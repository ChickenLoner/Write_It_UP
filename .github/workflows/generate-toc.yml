name: Auto Generate Table of Contents

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
  workflow_dispatch:

jobs:
  generate_toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate TOC and update README.md
        run: |
          # TOC markers
          TOC_START='<!-- TOC START -->'
          TOC_END='<!-- TOC END -->'

          # Find all Markdown files except README.md and .github
          TOC_ENTRIES=$(find . -type f -name "*.md" ! -name "README.md" ! -path "./.github/*" | sort | while read FILE; do
            CLEAN_PATH=${FILE#./}  # remove leading ./
            FILENAME_ONLY=$(basename "$FILE" .md)
            LINK_TEXT=$(echo "$FILENAME_ONLY" | tr '_' ' ' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
            echo "* [$LINK_TEXT]($CLEAN_PATH)"
          done)

          TOC_CONTENT="\n**Table of Contents (Auto-Generated)**\n\n$TOC_ENTRIES\n"

          # Replace old TOC between markers
          awk -v start="$TOC_START" -v end="$TOC_END" -v content="$TOC_CONTENT" '
            $0 == start { print; print content; in_toc=1; next }
            $0 == end { print; in_toc=0; next }
            !in_toc { print }
          ' README.md > README.md.new

          mv README.md.new README.md

      - name: Commit and push changes if README.md updated
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-generate Table of Contents"
          file_pattern: README.md
          commit_options: '--no-verify'
