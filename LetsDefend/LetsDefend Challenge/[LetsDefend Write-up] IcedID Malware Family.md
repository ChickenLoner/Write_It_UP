# [LetsDefend - IcedID Malware Family](https://app.letsdefend.io/challenge/IcedID-Malware-Family)
Created: 20/06/2024 08:57
Last Updated: 20/06/2024 13:02
* * *
<div align=center>

**IcedID Malware Family**
![b24072bfe0a1e399ae1b5976fd591c37.png](/_resources/b24072bfe0a1e399ae1b5976fd591c37.png)
</div>

Challenge Files (pass: infected): /root/Desktop/ChallengeFile/challenge-files.zip

~~Challenge Files (pass:infected): [Download](https://files-ld.s3.us-east-2.amazonaws.com/challenge-files.zip)~~

~~Files in the zip archive are malicious, analyze malicious files on isolated devices.~~

This challenge prepared by [@Bohan Zhang](https://www.linkedin.com/in/bohan-zhang-078751137/)

Sample Source: malware-traffic-analysis
* * *
## Start Investigation
>What is the sha256 hash for the malspam attachment?

![d074791da8e492378955e822252a6e4c.png](/_resources/d074791da8e492378955e822252a6e4c.png)

We got 8 files in total and the one that should be an attachment is doc file

![f980e2feeb9eb6fe328f924e3a1460c0.png](/_resources/f980e2feeb9eb6fe328f924e3a1460c0.png)

Which is a dropper of IceID malware

```
cc721111b5924cfeb91440ecaccc60ecc30d10fffbdab262f7c0a17027f527d1
```

>What is the child process command line when the user enabled the Macro?

![6aa01df9fd80e112f6d28596f27865dd.png](/_resources/6aa01df9fd80e112f6d28596f27865dd.png)

Lets confirm it if we can use `olevba` on this with `oleid` and we can see that `oleid` detected VBA Macros inside this doc file so we can proceed with `olevba`

![850f249641f2ed8bb5efac4bc65618de.png](/_resources/850f249641f2ed8bb5efac4bc65618de.png)

And we can see that `initVBA()` function will open/create `collectionBoxConst.hta` then writes the text content of the current active document into this file and close it.

![0347a70795088f3090f4b80b85e35711.png](/_resources/0347a70795088f3090f4b80b85e35711.png)
![207b1fb488dc81e9ab26f8febc786c45.png](/_resources/207b1fb488dc81e9ab26f8febc786c45.png)

Upon searching public report on any.run then you can see that `collectionBoxConst.hta` was executed by `explorer.exe`

```
explorer.exe collectionBoxConst.hta
```

>What is the HTML Application file's sha256 hash from previous question?

You can either generate hash using `sha256sum`

![ad6607b004c964af23339071b62e48b9.png](/_resources/ad6607b004c964af23339071b62e48b9.png)

or you can go to dropped files section under Relations tap on VirusTotal

![c255d3bb8ade54180e54eca3d8794e0d.png](/_resources/c255d3bb8ade54180e54eca3d8794e0d.png)

```
b25865183c5cd2c5e550aca8476e592b62ed3e37e6b628f955bbed454fdbb100
```

>Based on the previous question, what is the DLL run method?

![207b1fb488dc81e9ab26f8febc786c45.png](/_resources/207b1fb488dc81e9ab26f8febc786c45.png)

We can see that mshta was also used to execute `collectionBoxConst.hta` file then `rundll32.exe` was spawned under `mshta.exe` to execute an image file which should not be impossible since `rundll32.exe` is designed to execute dll file which mean `collectionBoxConst.jpg` is a dll file

```
"C:\Windows\System32\rundll32.exe" c:\users\public\collectionBoxConst.jpg,PluginInit
```

>What is the image file dll installer sha256 hash from previous question?

![d2518f9ce987e9d349fad804ccd84da3.png](/_resources/d2518f9ce987e9d349fad804ccd84da3.png)l

Go can either go to VirusTotal and get sha256 hash...

![735274ca4741db06f927664f8ed38891.png](/_resources/735274ca4741db06f927664f8ed38891.png)

Or using `sha256sum` to get this answer

```
51658887e46c88ed6d5861861a55c989d256a7962fb848fe833096ed6b049441
```

>What are the IP address and its domain name hosted installer DLL?

![4ad2a43ef456f6b3e036867be2b00c0b.png](/_resources/4ad2a43ef456f6b3e036867be2b00c0b.png)

We will have to analyze the content inside `collectionBoxConst.hta` which you can see that first part of this script is base64 encoded 

![01f31d7526f500f59c3f4f674e428aea.png](/_resources/01f31d7526f500f59c3f4f674e428aea.png)

Decode it then we can see then it does look like it need to be reverse and hello is the key that will tell decoding function to reverse all strings before "hello"

![3b87d1a47e6cf82b194750cbadd88c35.png](/_resources/3b87d1a47e6cf82b194750cbadd88c35.png)

Then after put reverse recipe, we can see that it uses HTTP GET method to download a file from C2 and save it to `collectionBoxConst.jpg` which is dll file we found earlier then we can search dns query for this domain to get an IP address 

![8ec8e962a384aff7e7e716f46a432c78.png](/_resources/8ec8e962a384aff7e7e716f46a432c78.png)

```
45.142.213.105, coursemcclurez.com
```

>What is the full URL for the DLL installer?
```
http://coursemcclurez.com/adda/T/5xBOnOkAQixWY7/JQNizzLtuT6BVV0xRecCKVVHAAR6PkgGrIPN/sose5?user=anRsIkfbv&time=0qobcg4DyUX11ZLF5yHrIevFn&page=1K2n8iJ&i9y9SwJu=yVaCtZ9s0gUfn&q=hj9xWh4I6PDdXOPDey&id=Vr4pf&user=mHMoD292T&search=uZVgg21LyVRFdD2FABGZvQlnkM90&q=Dwc1s67MbWC24TGoOjMXC
```

>What are the two IP addresses identified as C2 servers?

![d748d5edc26049676574e6292a993b7b.png](/_resources/d748d5edc26049676574e6292a993b7b.png)

Upon investigating dll on VirusTotal, then we can see which domain it was contacted 

![03ee4afe82b57ba922c4ed91a9811451.png](/_resources/03ee4afe82b57ba922c4ed91a9811451.png)

![9693b088e470398c8608478085d2c096.png](/_resources/9693b088e470398c8608478085d2c096.png)

And after following an IP of this domain lead us to another file downloading (`.bin`) 

![0e302fdb576f518a9f1b23021760e3b1.png](/_resources/0e302fdb576f518a9f1b23021760e3b1.png)

Then we can see that new domain was connected after file downloading was completed which mean the downloaded file is also a malware that contact other C2 server

![174c0fee3f3aa0c65af4940a48bc6e36.png](/_resources/174c0fee3f3aa0c65af4940a48bc6e36.png)

There is one more address that was contacted after first domain was contacted

```
185.33.85.35, 194.5.249.46
```

>What are the four C2 domains identified in the PCAP file?

![9845e740d8434d4eabb73fc95398e221.png](/_resources/9845e740d8434d4eabb73fc95398e221.png)

If we didn't count the domain that was downloaded malicious fake gzip.bin file then it will come down to 4 domains that was contacted after this file was executed

```
arhannexa5.top, extrimefigim.top, fimlubindu.top, kilodaser4.fit
```

>After the DLL installer being executed, what are the two domains that were being contacted by the installer DLL?

![0dfec9ab2aa0324c32c7f8456bbf84ae.png](/_resources/0dfec9ab2aa0324c32c7f8456bbf84ae.png)
```
aws.amazon.com, supplementik.top
```


>The malware generated traffic to an IP address over port 8080 with two SYN requests, what is the IP address?

![b1e34739cf3ffb08c05d9521138148c0.png](/_resources/b1e34739cf3ffb08c05d9521138148c0.png)

Try find for connection on port 8080 then you will have this IP address

```
38.135.122.194
```

>The license.dat file was used to create persistance on the user's machine, what is the dll run method for the persistance?

![8670f73f4aa3fb068f5760ef49a5c0ff.png](/_resources/8670f73f4aa3fb068f5760ef49a5c0ff.png)

Read content inside of `2021-06-02-scheduled-task.txt` then you can see that there is a task that going to execute `rundll32.exe` with this arguments

```
C:\Users\user1\AppData\Local\user1\Tetoomdu64.dll",update /i:"ComicFantasy\license.dat
```

>With OSINT, what is the malware family name used in this PCAP capture?
```
icedid
```

>Based on Palo Alto Unit 42, what is the APT Group name?

![fa80139bdc8005b25c48bfedbc97877c.png](/_resources/fa80139bdc8005b25c48bfedbc97877c.png)

[Here](https://unit42.paloaltonetworks.com/ta551-shathak-icedid/) is the blog that Palo Alto Unit 42 talking about this malware 

```
TA551
```

>What is the Mitre Attack code for the initial access in this campaign?

![3887d06195cbdf4351cbf79ac6020ef8.png](/_resources/3887d06195cbdf4351cbf79ac6020ef8.png)

As we read from Palo Alto Unit 42 blog post and analyzed an attachment file ourselves that this malware came as an email attachment so the initial access is spearphishng attachment.

```
T1566.001
```

* * *
## Summary

On this challenge, We analyzed IcedID malware from an attachment file to malicious hta file, dll file and bin file and found all C2 domains and addresses using Wireshark then later we found a schedule task to execute another malicious dll which is a persistence technique used by this malware 
<div align=center>

![2a9e5adb9d371a1b19b68a677fe76e2a.png](/_resources/2a9e5adb9d371a1b19b68a677fe76e2a.png)
https://app.letsdefend.io/my-rewards/detail/2cd3bbc63b474b1ca82636d60887885f
</div>

* * *